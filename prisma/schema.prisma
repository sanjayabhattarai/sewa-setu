generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum UserRole {
  USER
  ADMIN
}

enum HospitalType {
  HOSPITAL
  CLINIC
  LAB
}

enum ConsultationMode {
  ONLINE
  PHYSICAL
}

enum BookingStatus {
  DRAFT
  REQUESTED
  CONFIRMED
  CANCELLED
  COMPLETED
}

/**
 * =========================
 * ACCOUNTS & PATIENTS
 * =========================
 */

model User {
  id       String   @id @default(cuid())
  fullName String
  email    String   @unique
  phone    String?
  country  String
  role     UserRole @default(USER)

  patients Patient[]
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Patient {
  id          String    @id @default(cuid())
  userId      String
  fullName    String
  gender      String?
  dateOfBirth DateTime?
  phone       String?
  notes       String?

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([locationId])
}

/**
 * =========================
 * LOCATION
 * =========================
 */

model Location {
  id          String  @id @default(cuid())
  country     String
  province    String?
  district    String
  city        String
  area        String?
  addressLine String?
  postalCode  String?
  lat         Float?
  lng         Float?

  hospitals Hospital[]
  patients  Patient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, district, city])
}

/**
 * =========================
 * SPECIALTY & TAGS
 * =========================
 */

model Specialty {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  keywords    String?

  doctors     DoctorSpecialty[]
  departments HospitalDepartment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model Tag {
  id   String @id @default(cuid())
  name String @unique

  doctors   DoctorTag[]
  hospitals HospitalTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * HOSPITAL
 * =========================
 */

model Hospital {
  id         String       @id @default(cuid())
  slug       String       @unique
  name       String
  type       HospitalType
  locationId String

  phone              String?
  email              String?
  website            String?
  openingHours       String?
  emergencyAvailable Boolean @default(false)
  servicesSummary    String?
  verified           Boolean @default(false)

  location Location @relation(fields: [locationId], references: [id], onDelete: Restrict)

  doctors     DoctorHospital[]
  departments HospitalDepartment[]
  packages    HospitalPackage[]
  tags        HospitalTag[]
  media       HospitalMedia[]
  bookings    Booking[]

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  availabilitySlots AvailabilitySlot[]

  @@index([locationId])
  @@index([name])
}

/**
 * =========================
 * DOCTOR
 * =========================
 */

model Doctor {
  id              String  @id @default(cuid())
  fullName        String
  gender          String?
  experienceYears Int?
  education       String?
  bio             String?

  languages         Json?
  consultationModes Json?

  licenseNumber String?
  feeMin        Int?
  feeMax        Int?
  currency      String?
  verified      Boolean @default(false)

  hospitals    DoctorHospital[]
  specialties  DoctorSpecialty[]
  departments  DepartmentDoctor[]
  tags         DoctorTag[]
  services     DoctorService[]
  availability AvailabilitySlot[]
  media        DoctorMedia[]
  bookings     Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fullName])
  @@index([verified])
}

/**
 * =========================
 * HOSPITAL DEPARTMENTS
 * =========================
 */

model HospitalDepartment {
  id          String  @id @default(cuid())
  hospitalId  String
  specialtyId String?
  name        String
  slug        String
  overview    String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  dataOrigin String  @default("IMPORTED")
  sourceUrl  String?
  sourceHash String?

  hospital  Hospital   @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  specialty Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)

  doctors DepartmentDoctor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hospitalId, slug])
  @@index([hospitalId, isActive, sortOrder])
}

/**
 * =========================
 * DEPARTMENT DOCTOR LISTING
 * =========================
 */

model DepartmentDoctor {
  id           String @id @default(cuid())
  departmentId String
  doctorId     String

  designation String?
  education   String?
  profileText String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  department HospitalDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  doctor     Doctor             @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, doctorId])
  @@index([doctorId])
}

/**
 * =========================
 * PACKAGES
 * =========================
 */

model HospitalPackage {
  id          String  @id @default(cuid())
  hospitalId  String
  title       String
  description String?
  price       Int?
  currency    String?
  isActive    Boolean @default(true)

  dataOrigin String @default("MANUAL")

  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hospitalId, isActive])
}

/**
 * =========================
 * RELATIONS (M:N)
 * =========================
 */

model DoctorSpecialty {
  doctorId    String
  specialtyId String
  isPrimary   Boolean @default(false)

  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@id([doctorId, specialtyId])
}

model DoctorHospital {
  doctorId      String
  hospitalId    String
  positionTitle String?
  isPrimary     Boolean @default(false)

  doctor   Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  @@id([doctorId, hospitalId])
}

model DoctorTag {
  doctorId String
  tagId    String

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([doctorId, tagId])
}

model HospitalTag {
  hospitalId String
  tagId      String

  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([hospitalId, tagId])
}

/**
 * =========================
 * SERVICES & AVAILABILITY (FUTURE BOOKING READY)
 * =========================
 */

model DoctorService {
  id              String  @id @default(cuid())
  doctorId        String
  title           String
  price           Int?
  currency        String?
  durationMinutes Int?
  isActive        Boolean @default(true)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([doctorId])
}

model AvailabilitySlot {
  id                  String           @id @default(cuid())
  doctorId            String
  hospitalId          String?
  mode                ConsultationMode
  dayOfWeek           Int
  startTime           String
  endTime             String
  slotDurationMinutes Int
  isActive            Boolean          @default(true)

  doctor   Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  hospital Hospital? @relation(fields: [hospitalId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, hospitalId, mode, dayOfWeek, startTime, endTime])
  @@index([doctorId])
  @@index([hospitalId])
  @@index([dayOfWeek, mode])
}

/**
 * =========================
 * MEDIA
 * =========================
 */

model DoctorMedia {
  id        String  @id @default(cuid())
  doctorId  String
  url       String
  altText   String?
  isPrimary Boolean @default(false)

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HospitalMedia {
  id         String  @id @default(cuid())
  hospitalId String
  url        String
  altText    String?
  isPrimary  Boolean @default(false)

  hospital Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * BOOKING (READY FOR FUTURE)
 * =========================
 */

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  hospitalId String
  hospital   Hospital @relation(fields: [hospitalId], references: [id], onDelete: Restrict)

  doctorId String?
  doctor   Doctor? @relation(fields: [doctorId], references: [id], onDelete: SetNull)

  mode        ConsultationMode
  scheduledAt DateTime
  notes       String?

  status BookingStatus @default(DRAFT)

  @@index([userId])
  @@index([patientId])
  @@index([hospitalId])
  @@index([doctorId])
  @@index([status, scheduledAt])
}
